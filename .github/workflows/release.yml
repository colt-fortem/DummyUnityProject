name: Create Release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: Prerelease tag (optional)
        required: false
        type: string
        default: ''
      release-as:
        required: true
        type: choice
        default: auto
        description: If you want an automated or a manual version bump
        options:
          - auto
          - major
          - minor
          - patch

env:
  BUILD_NAME: TankGame

jobs:
  prepare:
    name: Prepare version and changelog
    runs-on: ubuntu-latest
    outputs:
      version-tag: ${{ steps.get-latest-tag.outputs.version-tag }}
      version: ${{ steps.get-version.outputs.version }}
      changelog: ${{ steps.get-changelog.outputs.changelog }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Versionize
        run: dotnet tool install --global Versionize

      - name: Set up git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Version bump
        env:
          PRERELEASE: ${{ github.event.inputs.prerelease }}
          RELEASE_AS: ${{ github.event.inputs.release-as }}
        run: >
          versionize --exit-insignificant-commits
          ${{ env.PRERELEASE != '' && format('--pre-release {0}', env.PRERELEASE) || '' }}
          ${{ env.RELEASE_AS != 'auto' && format('--release-as {0}', env.RELEASE_AS) || '' }}

      - name: Get latest tag
        id: get-latest-tag
        run: |
          echo "version-tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Get version without 'v' prefix
        id: get-version
        run: |
          version=${{ steps.get-latest-tag.outputs.version-tag }}
          version=${version#v}
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get changelog
        id: get-changelog
        run: |
          set -e
          if ! CHANGELOG=$(versionize changelog 2>&1); then
            echo "::error ::$CHANGELOG"
            exit 1
          fi
          # expose as step output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          printf "%s\n\n" "# What's changed?" >> $GITHUB_OUTPUT
          printf "%s\n" "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build:
    name: Build matrix (WebGL + Windows)
    needs: prepare
    # windows-latest
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [StandaloneWindows64, WebGL]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore gh-pages BuildHistory if present
        shell: bash
        run: |
          target=BuildHistory_${{ matrix.platform }}
          mkdir $target
          git checkout origin/gh-pages -- "$target" || true

      - name: Cache Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-${{ matrix.platform }}
          restore-keys: |
            Library-

      - name: Run Unity build
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          buildName: ${{ env.BUILD_NAME }}
          targetPlatform: ${{ matrix.platform }}
          versioning: Custom
          version: ${{ needs.prepare.outputs.version }}
          buildMethod: DevToolbox.Editor.BuildScript.Build
          customParameters: -buildHistoryPath BuildHistory_${{ matrix.platform }}/data.json -repoUrl https://github.com/${{ github.repository }}/releases/tag/

      - name: WebGL publish to gh-pages
        if: ${{ matrix.platform == 'WebGL' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/WebGL
          publish_branch: gh-pages
          destination_dir: Game
          # keep history and other files on gh-pages
          keep_files: true

      - name: publish BuildHistory to gh-pages
        # publish BuildHistory_<platform> to gh-pages under same path
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./BuildHistory_${{ matrix.platform }}
          publish_branch: gh-pages
          destination_dir: BuildHistory_${{ matrix.platform }}
          keep_files: true

      - name: Zip Windows build
        if: ${{ matrix.platform == 'StandaloneWindows64' }}
        shell: bash
        id: zip
        run: |
          set -e
          artifact_name=${{ env.BUILD_NAME }}_${{ needs.prepare.outputs.version-tag }}_${{ matrix.platform }}.zip
          pushd ./build/${{ matrix.platform }}
          zip -r ../../$artifact_name .
          popd
          echo "artifact-name=$artifact_name" >> $GITHUB_OUTPUT

      - name: Upload Windows artifact
        if: ${{ matrix.platform == 'StandaloneWindows64' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: ${{ steps.zip.outputs.artifact-name }}

  release:
    name: Create GitHub Release (attach Windows zip only)
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./release-artifacts

      - name: Create a Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version-tag }}
          prerelease: ${{ contains(needs.prepare.outputs.version-tag, '-') }}
          body: ${{ needs.prepare.outputs.changelog }}
          files: ./release-artifacts/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
